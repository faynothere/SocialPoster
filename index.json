(() => {
    if (window.SOCIAL_POST_EXT_LOADED) return;
    window.SOCIAL_POST_EXT_LOADED = true;

    const MODULE = 'socialPostExt';
    const DEFAULTS = {
        platform: 'facebook',
        style: 'complaint',
        includeRecentMessages: 5,
        autoGenerate: false
    };

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
    function getCtx() {
        try { return window.SillyTavern?.getContext?.() || null; } catch (_) { return null; }
    }

    function ensureSettings() {
        const ctx = getCtx();
        if (!ctx) return structuredClone(DEFAULTS);
        const store = ctx.extensionSettings || (ctx.extensionSettings = {});
        if (!store[MODULE]) store[MODULE] = {};
        for (const k of Object.keys(DEFAULTS)) if (!(k in store[MODULE])) store[MODULE][k] = DEFAULTS[k];
        return store[MODULE];
    }

    function saveSettings() {
        const ctx = getCtx();
        (ctx?.saveSettingsDebounced || ctx?.saveSettings || (() => { })).call(ctx);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    function getRecentConversation(limit = 5) {
        const ctx = getCtx();
        if (!ctx?.chat) return [];
        
        const recentMessages = ctx.chat.slice(-limit);
        return recentMessages.map(msg => {
            const name = msg.name || (msg.is_user ? 'User' : 'Character');
            const message = msg.mes || '';
            return { name, message, is_user: msg.is_user };
        });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå
    async function generateSocialPost() {
        const settings = ensureSettings();
        const recentConvo = getRecentConversation(settings.includeRecentMessages);
        
        if (recentConvo.length === 0) {
            throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå');
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
        const conversationSummary = recentConvo.map(msg => 
            `${msg.name}: ${msg.message}`
        ).join('\n');

        const charName = recentConvo.find(msg => !msg.is_user)?.name || '{{char}}';
        const platform = settings.platform;
        const style = settings.style;

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á prompt ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI
        const prompt = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå${platform === 'twitter' ? '‡∏ó‡∏ß‡∏¥‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡πå' : platform === 'instagram' ? '‡∏≠‡∏¥‡∏ô‡∏™‡∏ï‡∏≤‡πÅ‡∏Å‡∏£‡∏°' : '‡πÄ‡∏ü‡∏™‡∏ö‡∏∏‡πä‡∏Ñ'}‡πÉ‡∏ô‡∏™‡πÑ‡∏ï‡∏•‡πå"${style}"‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£"${charName}"‡∏à‡∏≤‡∏Å‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:

‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:
${conversationSummary}

‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:
- ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πâ‡∏ô ‡∏Å‡∏£‡∏∞‡∏ó‡∏±‡∏î‡∏£‡∏±‡∏î ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö${platform === 'twitter' ? '‡∏ó‡∏ß‡∏¥‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡πå (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 280 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)' : platform === 'instagram' ? '‡∏≠‡∏¥‡∏ô‡∏™‡∏ï‡∏≤‡πÅ‡∏Å‡∏£‡∏° (‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏ô‡πà‡∏≤‡∏≠‡πà‡∏≤‡∏ô)' : '‡πÄ‡∏ü‡∏™‡∏ö‡∏∏‡πä‡∏Ñ (‡∏¢‡∏≤‡∏ß‡πÑ‡∏î‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)'}
- ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå${style} (‡∏ö‡πà‡∏ô/‡∏õ‡∏£‡∏∞‡∏ä‡∏î/‡∏ï‡∏•‡∏Å/‡∏à‡∏£‡∏¥‡∏á‡∏à√°m ‡∏Ø‡∏•‡∏Ø)
- ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á${charName}
- ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
- ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÇ‡∏ã‡πÄ‡∏ä‡∏µ‡∏¢‡∏•‡∏°‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏à‡∏£‡∏¥‡∏á‡πÜ
- ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ä‡πà‡∏ô "‡πÇ‡∏û‡∏™‡∏ï‡πå:" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ó‡∏ß‡∏¥‡∏ï:"

‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ:`;

        try {
            const ctx = getCtx();
            const apiResult = await ctx.generateQuietPrompt(prompt);
            
            if (!apiResult || typeof apiResult !== 'string') {
                throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÑ‡∏î‡πâ');
            }

            // ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ
            let cleanedPost = apiResult.trim();
            cleanedPost = cleanedPost.replace(/^["']|["']$/g, ''); // ‡∏•‡∏ö quotation marks ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
            cleanedPost = cleanedPost.split('\n')[0]; // ‡πÉ‡∏ä‡πâ‡πÅ‡∏Ñ‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å

            return {
                content: cleanedPost,
                platform: platform,
                character: charName,
                timestamp: new Date().toLocaleString('th-TH'),
                style: style
            };
        } catch (error) {
            console.error('Error generating social post:', error);
            throw new Error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå: ' + error.message);
        }
    }

    // ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏û‡∏™‡∏ï‡πå
    class SocialPostManager {
        constructor() {
            this.posts = this.loadPosts();
        }

        loadPosts() {
            try {
                return JSON.parse(localStorage.getItem('social_posts') || '[]');
            } catch {
                return [];
            }
        }

        savePosts() {
            localStorage.setItem('social_posts', JSON.stringify(this.posts));
        }

        addPost(post) {
            const postWithId = {
                ...post,
                id: Date.now().toString(),
                createdAt: new Date().toISOString()
            };
            this.posts.unshift(postWithId);
            this.savePosts();
            return postWithId;
        }

        deletePost(id) {
            this.posts = this.posts.filter(post => post.id !== id);
            this.savePosts();
        }

        clearAllPosts() {
            this.posts = [];
            this.savePosts();
        }
    }

    // UI Components
    function createModal() {
        if (document.getElementById('social-post-modal')) return;

        const modal = document.createElement('div');
        modal.id = 'social-post-modal';
        modal.innerHTML = `
            <div id="social-post-modal__content">
                <div id="social-post-modal__header">
                    <h3 id="social-post-modal__title">‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÇ‡∏ã‡πÄ‡∏ä‡∏µ‡∏¢‡∏•‡∏°‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</h3>
                    <button id="social-post-modal__close">&times;</button>
                </div>
                <div id="social-post-modal__posts"></div>
                <div id="social-post-modal__loading" style="display: none;">
                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå...
                </div>
                <div id="social-post-modal__empty" style="display: none;">
                    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // Event listeners
        document.getElementById('social-post-modal__close').addEventListener('click', hideModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) hideModal();
        });
    }

    function showModal() {
        const modal = document.getElementById('social-post-modal');
        const postsContainer = document.getElementById('social-post-modal__posts');
        const loading = document.getElementById('social-post-modal__loading');
        const empty = document.getElementById('social-post-modal__empty');

        modal.style.display = 'flex';
        renderPosts();

        function renderPosts() {
            const postManager = new SocialPostManager();
            const posts = postManager.posts;

            postsContainer.innerHTML = '';
            loading.style.display = 'none';

            if (posts.length === 0) {
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';

            posts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.className = `social-post ${post.platform}`;
                postElement.innerHTML = `
                    <div class="social-post__header">
                        <div class="social-post__avatar">${post.character.charAt(0)}</div>
                        <div class="social-post__info">
                            <div class="social-post__name">${post.character}</div>
                            <div class="social-post__meta">
                                ${post.timestamp}
                                <span class="social-post__platform">${post.platform}</span>
                            </div>
                        </div>
                    </div>
                    <div class="social-post__content">${post.content}</div>
                    <div class="social-post__actions">
                        <button class="social-post__action copy-post" data-id="${post.id}">
                            üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
                        </button>
                        <button class="social-post__action delete-post" data-id="${post.id}">
                            üóëÔ∏è ‡∏•‡∏ö
                        </button>
                    </div>
                `;
                postsContainer.appendChild(postElement);
            });

            // Add event listeners for actions
            postsContainer.querySelectorAll('.copy-post').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const postId = e.target.closest('.copy-post').dataset.id;
                    const post = postManager.posts.find(p => p.id === postId);
                    if (post) {
                        navigator.clipboard.writeText(post.content).then(() => {
                            showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß!');
                        });
                    }
                });
            });

            postsContainer.querySelectorAll('.delete-post').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const postId = e.target.closest('.delete-post').dataset.id;
                    postManager.deletePost(postId);
                    renderPosts();
                    showToast('‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß!');
                });
            });
        }
    }

    function hideModal() {
        document.getElementById('social-post-modal').style.display = 'none';
    }

    function showToast(message) {
        // ‡πÉ‡∏ä‡πâ toast ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
        let toast = document.getElementById('social-post-toast');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = 'social-post-toast';
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--SmartThemeEmColor);
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                z-index: 100001;
                opacity: 0;
                transition: opacity 0.3s;
            `;
            document.body.appendChild(toast);
        }

        toast.textContent = message;
        toast.style.opacity = '1';

        setTimeout(() => {
            toast.style.opacity = '0';
        }, 2000);
    }

    // Main UI
    function addUI() {
        if (document.querySelector('#social-post-ext__container')) return;

        const mount = document.querySelector('.chat-input-container, .input-group, .send-form, #send_form, .chat-controls, .st-user-input') || document.body;

        const container = document.createElement('div');
        container.id = 'social-post-ext__container';

        const button = document.createElement('button');
        button.id = 'social-post-ext__btn';
        button.textContent = 'üì± ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå';
        button.title = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÇ‡∏ã‡πÄ‡∏ä‡∏µ‡∏¢‡∏•‡∏°‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏à‡∏≤‡∏Å‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';

        const menu = document.createElement('div');
        menu.id = 'social-post-ext__menu';

        // Platform selection
        const platformLabel = document.createElement('label');
        platformLabel.innerHTML = `
            <span>‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°:</span>
            <select id="social-post-platform">
                <option value="facebook">Facebook</option>
                <option value="twitter">Twitter</option>
                <option value="instagram">Instagram</option>
            </select>
        `;

        // Style selection
        const styleLabel = document.createElement('label');
        styleLabel.innerHTML = `
            <span>‡∏™‡πÑ‡∏ï‡∏•‡πå:</span>
            <select id="social-post-style">
                <option value="complaint">‡∏ö‡πà‡∏ô/‡∏õ‡∏£‡∏∞‡∏ä‡∏î</option>
                <option value="funny">‡∏ï‡∏•‡∏Å</option>
                <option value="serious">‡∏à‡∏£‡∏¥‡∏á‡∏à√°m</option>
                <option value="excited">‡∏ï‡∏∑‡πà‡∏ô‡πÄ‡∏ï‡πâ‡∏ô</option>
                <option value="sad">‡πÄ‡∏®‡∏£‡πâ‡∏≤</option>
            </select>
        `;

        // Message count
        const countLabel = document.createElement('label');
        countLabel.innerHTML = `
            <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</span>
            <input type="number" id="social-post-count" min="1" max="10" value="5" style="width: 60px;">
        `;

        // Auto-generate option
        const autoLabel = document.createElement('label');
        autoLabel.innerHTML = `
            <input type="checkbox" id="social-post-auto">
            <span>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</span>
        `;

        menu.append(platformLabel, styleLabel, countLabel, autoLabel);
        container.append(button, menu);

        // Load settings
        const settings = ensureSettings();
        document.getElementById('social-post-platform').value = settings.platform;
        document.getElementById('social-post-style').value = settings.style;
        document.getElementById('social-post-count').value = settings.includeRecentMessages;
        document.getElementById('social-post-auto').checked = settings.autoGenerate;

        // Event listeners for settings changes
        document.getElementById('social-post-platform').addEventListener('change', (e) => {
            settings.platform = e.target.value;
            saveSettings();
        });

        document.getElementById('social-post-style').addEventListener('change', (e) => {
            settings.style = e.target.value;
            saveSettings();
        });

        document.getElementById('social-post-count').addEventListener('change', (e) => {
            settings.includeRecentMessages = parseInt(e.target.value);
            saveSettings();
        });

        document.getElementById('social-post-auto').addEventListener('change', (e) => {
            settings.autoGenerate = e.target.checked;
            saveSettings();
        });

        // Button click handler
        let menuOpen = false;

        button.addEventListener('click', async () => {
            if (!menuOpen) {
                const loading = document.getElementById('social-post-modal__loading');
                const postsContainer = document.getElementById('social-post-modal__posts');
                
                showModal();
                loading.style.display = 'block';
                postsContainer.style.display = 'none';

                try {
                    const post = await generateSocialPost();
                    const postManager = new SocialPostManager();
                    postManager.addPost(post);
                    showModal(); // Refresh modal to show new post
                    showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                } catch (error) {
                    showToast(error.message);
                    loading.style.display = 'none';
                    postsContainer.style.display = 'block';
                }
            }
        });

        button.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            menu.style.display = menuOpen ? 'none' : 'flex';
            menuOpen = !menuOpen;
        });

        document.addEventListener('click', (e) => {
            if (!container.contains(e.target)) {
                menu.style.display = 'none';
                menuOpen = false;
            }
        });

        if (mount === document.body) {
            container.style.position = 'fixed';
            container.style.bottom = '12px';
            container.style.left = '12px';
            container.style.zIndex = '9999';
        }

        mount.appendChild(container);
        createModal();
    }

    // Auto-generation on message send
    function hookMessageEvents() {
        const ctx = getCtx();
        if (!ctx?.eventSource) return;

        ctx.eventSource.on(ctx.event_types.MESSAGE_SENT, async () => {
            const settings = ensureSettings();
            if (settings.autoGenerate && Math.random() < 0.3) { // 30% chance to auto-generate
                setTimeout(async () => {
                    try {
                        const post = await generateSocialPost();
                        const postManager = new SocialPostManager();
                        postManager.addPost(post);
                        showToast(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå${settings.platform}‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥!`);
                    } catch (error) {
                        console.log('Auto-post generation failed:', error);
                    }
                }, 1000);
            }
        });
    }

    // Initialize
    function init() {
        ensureSettings();
        addUI();
        createModal();
        hookMessageEvents();
    }

    // Wait for DOM and ST to be ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        setTimeout(init, 1000);
    }

    // Export for global access
    window.SocialPostExtension = {
        generateSocialPost,
        showModal,
        hideModal,
        init
    };
})();
